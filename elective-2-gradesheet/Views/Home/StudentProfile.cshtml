@using elective_2_gradesheet.Data.Entities
@model StudentProfileViewModel


@{
    ViewData["Title"] = "Student Profile";
}

<body data-toast-message="@TempData["ToastMessage"]" data-toast-type="@TempData["ToastType"]">

    <div class="container mt-5">
        <div class="card mb-4">
            <div class="card-header">
                <h3>@Model.StudentFullName</h3>
            </div>
            <div class="card-body">
                <p><strong>Section:</strong> @Model.SectionName</p>
            </div>
        </div>

        <h4 class="mb-3">Activities</h4>

        <div class="card mt-5 mb-4 p-3 border rounded">
            <div class="card-body p-0">
                <div class="row g-3 align-items-end">
                    <div class="col-md-6">
                        <form asp-action="StudentProfile" method="get">
                            <input type="hidden" name="id" value="@Model.StudentId" />
                            <div class="row g-3 align-items-end">
                                <div class="col-md-8">
                                    <label class="form-label">Filter by Period:</label>
                                    <select name="period" asp-for="CurrentPeriod" asp-items="Html.GetEnumSelectList<GradingPeriod>()" class="form-control">
                                        <option value="">All Periods</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <button type="submit" class="btn btn-primary w-100">Filter</button>
                                </div>
                            </div>
                        </form>
                    </div>

                    <div class="col-md-6">
                        <form id="bulkAddForm" asp-action="BulkAddMissingActivities" method="post">
                            <input type="hidden" name="studentId" value="@Model.StudentId" />
                            @Html.AntiForgeryToken()
                            <div class="row g-3 align-items-end">
                                <div class="col-md-8">
                                    <label for="bulkAddPeriod" class="form-label">Bulk Add Missing for Period:</label>
                                    <select id="bulkAddPeriod" name="gradingPeriod" asp-items="Html.GetEnumSelectList<GradingPeriod>()" class="form-control" required>
                                        <option value="">Select Period</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <button type="submit" class="btn btn-warning w-100">Bulk Add Missing</button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        <div class="table-responsive">
            <table class="table table-striped table-bordered">
                <thead class="thead-dark">
                    <tr>
                        <th>
                            <a asp-action="StudentProfile" asp-route-id="@Model.StudentId" asp-route-sortOrder="@ViewData["PeriodSortParm"]" asp-route-period="@Model.CurrentPeriod">Period</a>
                        </th>
                        <th>Activity Name</th>
                        <th>Status</th>
                        <th>Points</th>
                        <th>Max Points</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var item in Model.Activities)
                    {
                        <tr class="@(item.Status == "Missing" ? "table-warning" : "")">
                            <td>@item.GradingPeriod</td>
                            <td>@item.ActivityName</td>
                            <td>@item.Status</td>
                            <td>@item.Points</td>
                            <td>@item.MaxPoints</td>
                            <td class="align-content-center">
                                @if (item.Status == "Missing")
                                {
                                    <a href="#" class="add-activity" data-bs-toggle="modal" data-bs-target="#editActivityModal"
                                       data-activity-id="0"
                                       data-activity-name="@item.ActivityName"
                                       data-points="0"
                                       data-max-points="@item.MaxPoints"
                                       data-period="@item.GradingPeriod"
                                       data-tag=""
                                       data-status="Missing">
                                        <span class="badge bg-secondary float-end">Fix</span>
                                    </a>
                                }
                                else
                                {
                                    <a href="#" class="edit-activity" data-bs-toggle="modal" data-bs-target="#editActivityModal"
                                       data-activity-id="@item.ActivityId"
                                       data-activity-name="@item.ActivityName"
                                       data-points="@item.Points"
                                       data-max-points="@item.MaxPoints"
                                       data-period="@item.GradingPeriod"
                                       data-tag="@item.Tag"
                                       data-github-link="@item.GithubLink"
                                       data-status="Submitted">
                                        <span class="badge bg-primary float-end">Edit</span>
                                    </a>
                                }
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>

    <div class="modal fade" id="editActivityModal" tabindex="-1" aria-labelledby="editActivityModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editActivityModalLabel">Edit Activity</h5>
                    <button type="button" class="btn btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form asp-action="UpdateActivity" method="post">
                    <div class="modal-body">
                        <ul class="nav nav-tabs" id="myTab" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="details-tab" data-bs-toggle="tab" data-bs-target="#details" type="button" role="tab" aria-controls="details" aria-selected="true">Details & Upload</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="rubric-tab" data-bs-toggle="tab" data-bs-target="#rubric" type="button" role="tab" aria-controls="rubric" aria-selected="false">JSON Rubric</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="results-tab" data-bs-toggle="tab" data-bs-target="#results" type="button" role="tab" aria-controls="results" aria-selected="false" style="display: none;">Scoring Results</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="console-tab" data-bs-toggle="tab" data-bs-target="#console" type="button" role="tab" aria-controls="console" aria-selected="false" style="display: none;">Scan Log</button>
                            </li>
                        </ul>
                        <div class="tab-content" id="myTabContent">
                            <div class="tab-pane fade show active" id="details" role="tabpanel" aria-labelledby="details-tab">
                                <div class="row mt-3">
                                    <div class="col-md-6">
                                        <input type="hidden" name="studentId" value="@Model.StudentId" />
                                        <input type="hidden" id="editActivityId" name="activityId" />
                                        <input type="hidden" id="editActivityNameInput" name="activityName" />

                                        <div class="mb-3">
                                            <label class="form-label">Activity Name</label>
                                            <p id="editActivityName" class="form-control-plaintext"></p>
                                        </div>

                                        <div class="row">
                                            <div class="col-md-4">
                                                <div class="mb-3">
                                                    <label for="editPoints" class="form-label">Points</label>
                                                    <input type="number" id="editPoints" name="points" class="form-control" step="any" required />
                                                </div>
                                            </div>
                                            <div class="col-md-4">
                                                <div class="mb-3" id="maxPointsContainer">
                                                    <label for="editMaxPoints" class="form-label">Max Points</label>
                                                    <input type="number" id="editMaxPoints" name="maxPoints" class="form-control" step="any" required />
                                                </div>
                                            </div>
                                            <div class="col-md-4">
                                                <div class="mb-3">
                                                    <label for="editPercent" class="form-label">Percent</label>
                                                    <input type="number" id="editPercent" name="percent" class="form-control" readonly />
                                                </div>
                                            </div>
                                        </div>

                                        <div class="mb-3" id="githubLinkContainer">
                                            <label for="editGithubLink" class="form-label">Github Link</label>
                                            <div class="input-group">
                                                <input type="text" id="editGithubLink" name="githubLink" class="form-control" />
                                                <button type="button" id="cloneButton" class="btn btn-outline-primary">Clone</button>
                                            </div>
                                        </div>

                                        <div class="mb-3" id="cloneDirectoryContainer">
                                            <label for="cloneDirectory" class="form-label">Clone Output Directory (optional)</label>
                                            <div class="input-group">
                                                <input type="text" id="cloneDirectory" name="cloneDirectory" class="form-control" placeholder="Leave blank for default location" />
                                                <button type="button" id="browseDirectoryButton" class="btn btn-outline-secondary">
                                                    <i class="fas fa-folder-open"></i> Browse
                                                </button>
                                            </div>
                                            <div class="form-text">Default location: ~/GradesheetClones/[repository-name]</div>
                                        </div>

                                        <div class="mb-3">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="useClonedRepo" />
                                                <label class="form-check-label" for="useClonedRepo">
                                                    Use cloned repository (hides file upload)
                                                </label>
                                            </div>
                                        </div>

                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="mb-3" id="periodContainer">
                                                    <label for="editPeriod" class="form-label">Grading Period</label>
                                                    <select id="editPeriod" name="period" asp-items="Html.GetEnumSelectList<GradingPeriod>()" class="form-control" required></select>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="mb-3" id="statusContainer">
                                                    <label for="editStatus" class="form-label">Status</label>
                                                    <select id="editStatus" name="status" class="form-control" required>
                                                        <option value="Added">Added</option>
                                                        <option value="Turned in">Turned in</option>
                                                        <option value="Missing">Missing</option>
                                                    </select>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="mb-3" id="tagContainer">
                                                    <label for="editTag" class="form-label">Tag</label>
                                                    <select id="editTag" name="tag" class="form-control" required>
                                                        <option value="Assignment">Assignment</option>
                                                        <option value="Hands-on">Hands-on</option>
                                                        <option value="Other">Other</option>
                                                    </select>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="mb-3" id="otherTagContainer" style="display: none;">
                                                    <label for="otherTag" class="form-label">Custom Tag</label>
                                                    <input type="text" id="otherTag" name="otherTag" class="form-control" placeholder="Not assignment or hands-on" />
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3" id="fileUploadContainer">
                                            <label for="fileUpload" class="form-label">Upload Files</label>
                                            <input type="file" id="fileUpload" class="form-control" multiple webkitdirectory>
                                        </div>
                                        <div id="fileTreeView"></div>
                                        <div id="clonedRepoInfo" class="alert alert-info" style="display: none;">
                                            <strong>Cloned Repository:</strong> <span id="clonedRepoPath"></span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="tab-pane fade" id="rubric" role="tabpanel" aria-labelledby="rubric-tab">
                                <div class="row mt-3">
                                    <div class="col-md-12">
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <label for="rubricJson" class="form-label">Rubric (JSON)</label>
                                            <div>
                                                <button type="button" class="btn btn-sm btn-outline-secondary me-2" id="prettifyJsonButton">Prettify</button>
                                                <button type="button" class="btn btn-sm btn-outline-secondary" id="copyRubricButton">Copy</button>
                                            </div>
                                        </div>
                                        <textarea id="rubricJson" class="form-control" rows="15">[
    {
        "name": "Student class with constructors",
        "points": 10,
        "keywords": ["Student", "constructor", "default", "firstName", "lastName"],
        "files": ["Models/Student.cs"]
    },
    {
        "name": "Student class properties and methods",
        "points": 15,
        "keywords": [
            "FirstName",
            "LastName",
            "SetFirstName",
            "SetLastName",
            "Title",
            "Course",
            "Section",
            "Birthday",
            "SetGender",
            "Gender"
        ],
        "files": ["Models/Student.cs"]
    },
    {
        "name": "Gender enum defined",
        "points": 5,
        "keywords": ["enum", "Gender", "Unknown", "Male", "Female"],
        "files": ["Models/Student.cs"]
    },
    {
        "name": "Computed properties FullName and Age",
        "points": 10,
        "keywords": ["FullName", "Age", "Birthday", "Title", "FirstName", "LastName"],
        "files": ["Models/Student.cs"]
    },
    {
        "name": "Index.cshtml creates List<Student> with 10 entries",
        "points": 20,
        "keywords": ["Index.cshtml", "List<Student>", "new Student", "Add", "10"],
        "files": ["Views/Home/Index.cshtml"]
    },
    {
        "name": "Index.cshtml displays Student table",
        "points": 30,
        "keywords": [
            "table",
            "FullName",
            "Gender",
            "Course",
            "Section",
            "Birthday",
            "Age",
            "foreach"
        ],
        "files": ["Views/Home/Index.cshtml"]
    },
    {
        "name": "No controller logic used",
        "points": 10,
        "keywords": ["Index.cshtml only", "no controller"],
        "files": ["Views/Home/Index.cshtml"]
    }
]</textarea>
                                    </div>
                                </div>
                            </div>
                            <div class="tab-pane fade" id="results" role="tabpanel" aria-labelledby="results-tab">
                                <div id="scoringResultsContainer" class="card mt-3">
                                    <div class="card-header text-center">
                                        <h5>Scoring Results</h5>
                                    </div>
                                    <div class="card-body p-0">
                                        <table class="table table-striped table-bordered mb-0" id="scoringResultsTable">
                                            <thead class="thead-dark">
                                                <tr>
                                                    <th>Met</th>
                                                    <th>File</th>
                                                    <th>Criterion</th>
                                                    <th>Points</th>
                                                    <th>Proof</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                            <div class="tab-pane fade" id="console" role="tabpanel" aria-labelledby="console-tab">
                                <div class="card mt-3">
                                    <div class="card-header d-flex justify-content-between align-items-center">
                                        <h5 class="mb-0">Scan Log</h5>
                                        <button type="button" class="btn btn-sm btn-outline-secondary" id="clearScanLogButton">
                                            <i class="fas fa-trash"></i> Clear Log
                                        </button>
                                    </div>
                                    <div class="card-body">
                                        <textarea id="scanLogText" class="form-control" rows="20" readonly style="font-family: 'Consolas', 'Monaco', 'Courier New', monospace; font-size: 12px; background-color: #f8f9fa;">Scan log will appear here when you run a repository check...</textarea>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="button" id="checkButton" class="btn btn-success" disabled>Check</button>
                        <button type="button" id="checkRepoButton" class="btn btn-info" disabled style="display: none;">Check (Repo)</button>
                        <button type="submit" class="btn btn-primary">Save changes</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="toast-container position-fixed bottom-0 end-0 p-3">
        <div id="liveToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header">
                <strong class="me-auto" id="toastHeader">Notification</strong>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="toast-body" id="toastBody">
            </div>
        </div>
    </div>

</body>

@section Scripts {
    <link rel="stylesheet" href="~/css/tree-view.css" />
    <script src="~/js/studentProfile.js"></script>
}